<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AhorraYa</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#161a22;--muted:#8a93a6;--text:#e6e9f2;--brand:#ff7a00;--pill:#22293a;--ok:#10b981;
      --field:#0f1320;--border:#1f2532;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1120px;margin:32px auto;padding:0 16px}
    h1{font-size:34px;margin:0 0 18px;font-weight:900}
    h2{font-size:14px;margin:0 0 8px;color:var(--muted);font-weight:600;letter-spacing:.02em}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .four{grid-template-columns:repeat(4,1fr)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    input,select{width:100%;background:var(--field);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
    input:focus,select:focus{border-color:#334155}
    .row{display:flex;gap:12px;align-items:end;flex-wrap:wrap}
    .btn{background:var(--brand);color:#101114;border:0;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .results{margin-top:16px}
    .card{display:flex;align-items:center;gap:16px;padding:14px 16px;border:1px solid var(--border);background:#121723;border-radius:12px}
    .card + .card{margin-top:10px}
    .logo{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;font-weight:800}
    .usps{background:#224;color:#fff}.ups{background:#532;color:#fff}.fedex{background:#242;color:#fff}
    .svc{font-weight:700}
    .price{margin-left:auto;font-weight:900}
    .pill{font-size:12px;background:var(--pill);border:1px solid #2a3347;border-radius:999px;padding:4px 8px;color:var(--muted)}
    .err{color:#fda4af;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
    .hide{display:none}
    @media (max-width:900px){.two{grid-template-columns:1fr}.four{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AhorraYa</h1>

    <!-- ORIGEN / DESTINO -->
    <div class="grid two">
      <div class="panel">
        <h2>Origen</h2>
        <div class="grid four">
          <div style="grid-column: span 2">
            <label>Calle</label>
            <input id="oStreet" placeholder="20102 NW 27th Cir" value="20102 NW 27th Cir">
          </div>
          <div>
            <label>País</label>
            <select id="oCountry"></select>
          </div>
          <div>
            <label>Estado / Provincia</label>
            <select id="oState"></select>
            <input id="oStateText" class="hide" placeholder="Provincia/Estado (texto)">
          </div>
          <div>
            <label>Ciudad</label>
            <input id="oCity" list="oCityList" placeholder="Miami Gardens" value="Miami Gardens">
            <datalist id="oCityList"></datalist>
          </div>
          <div>
            <label>ZIP / Código postal</label>
            <input id="oZip" placeholder="33056" value="33056">
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Destino</h2>
        <div class="grid four">
          <div style="grid-column: span 2">
            <label>Calle</label>
            <input id="dStreet" placeholder="1101 Brickell Ave" value="1101 Brickell Ave">
          </div>
          <div>
            <label>País</label>
            <select id="dCountry"></select>
          </div>
          <div>
            <label>Estado / Provincia</label>
            <select id="dState"></select>
            <input id="dStateText" class="hide" placeholder="Provincia/Estado (texto)">
          </div>
          <div>
            <label>Ciudad</label>
            <input id="dCity" list="dCityList" placeholder="Miami" value="Miami">
            <datalist id="dCityList"></datalist>
          </div>
          <div>
            <label>ZIP / Código postal</label>
            <input id="dZip" placeholder="33131" value="33131">
          </div>
        </div>
      </div>
    </div>

    <!-- PAQUETE -->
    <div class="panel" style="margin-top:12px">
      <div class="row">
        <div style="min-width:140px;flex:1">
          <label>Peso (kg)</label><input id="w" type="number" step="0.01" value="2.5">
        </div>
        <div style="min-width:120px"><label>Largo (cm)</label><input id="l" type="number" step="1" value="30"></div>
        <div style="min-width:120px"><label>Ancho (cm)</label><input id="an" type="number" step="1" value="20"></div>
        <div style="min-width:120px"><label>Alto (cm)</label><input id="al" type="number" step="1" value="10"></div>
        <button id="btn" class="btn">Consultar tarifas reales</button>
      </div>
      <div id="msg" class="err" style="margin-top:10px"></div>
    </div>

    <!-- RESULTADOS -->
    <div id="results" class="results"></div>
  </div>

  <script>
    // ======= Datos: países (ISO-3166), estados/provincias y ciudades sugeridas =======
    const COUNTRIES = [
      {code:'US',name:'United States'},
      {code:'CA',name:'Canada'},
      {code:'MX',name:'México'},
      {code:'AR',name:'Argentina'},{code:'BR',name:'Brasil'},{code:'CL',name:'Chile'},
      {code:'CO',name:'Colombia'},{code:'CR',name:'Costa Rica'},{code:'DO',name:'República Dominicana'},
      {code:'EC',name:'Ecuador'},{code:'ES',name:'España'},{code:'FR',name:'France'},
      {code:'DE',name:'Germany'},{code:'GT',name:'Guatemala'},{code:'HN',name:'Honduras'},
      {code:'IT',name:'Italia'},{code:'NI',name:'Nicaragua'},{code:'PA',name:'Panamá'},
      {code:'PE',name:'Perú'},{code:'PR',name:'Puerto Rico'},{code:'SV',name:'El Salvador'},
      {code:'UK',name:'United Kingdom'},{code:'UY',name:'Uruguay'},{code:'VE',name:'Venezuela'}
    ];

    const STATES_US = [
      'AL','AK','AZ','AR','CA','CO','CT','DC','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'
    ];
    const STATES_CA = ['AB','BC','MB','NB','NL','NS','NT','NU','ON','PE','QC','SK','YT'];
    const STATES_MX = ['AG','BC','BS','CM','CO','CL','CS','CH','DF','DG','GT','GR','HG','JA','MX','MI','MO','NA','NL','OA','PU','QE','QR','SL','SI','SO','TB','TM','TL','VE','YU','ZA'];

    const STATE_MAP = { US: STATES_US, CA: STATES_CA, MX: STATES_MX };

    // Sugerencias (ejemplos) por estado
    const CITY_SUGGEST = {
      US: {
        FL: ['Miami','Miami Gardens','Hialeah','Orlando','Tampa','Jacksonville'],
        CA: ['Los Angeles','San Diego','San Francisco','San Jose','Sacramento'],
        NY: ['New York','Buffalo','Rochester','Syracuse'],
        TX: ['Houston','Dallas','Austin','San Antonio']
      },
      CA: {
        ON: ['Toronto','Ottawa','Mississauga'], QC:['Montréal','Québec'], BC:['Vancouver','Victoria'],
      },
      MX: {
        JA:['Guadalajara','Zapopan'], DF:['Ciudad de México'], NL:['Monterrey'], PU:['Puebla']
      }
    };

    // ======= Helpers UI =======
    const $ = s=>document.querySelector(s);
    const byId = id=>document.getElementById(id);

    function fillCountries(sel, def='US'){
      sel.innerHTML = COUNTRIES.map(c=>`<option value="${c.code}">${c.name}</option>`).join('');
      sel.value = def;
    }

    function toggle(el, show){ el.classList.toggle('hide', !show); }

    function populateStates(countrySel, stateSel, stateText, cityInput, cityList){
      const code = countrySel.value;
      const list = STATE_MAP[code];
      if(list){
        // select visible
        toggle(stateSel, true); toggle(stateText,false);
        stateSel.innerHTML = `<option value="">—</option>` + list.map(s=>`<option value="${s}">${s}</option>`).join('');
        stateSel.value = (code==='US'?'FL': (code==='CA'?'ON':'')); // default util
      }else{
        // free text visible
        toggle(stateSel,false); toggle(stateText,true);
        stateText.value = '';
      }
      updateCitySuggestions(code, stateSel, stateText, cityInput, cityList);
    }

    function updateCitySuggestions(countryCode, stateSel, stateText, cityInput, cityList){
      const state = STATE_MAP[countryCode] ? stateSel.value : stateText.value.trim().toUpperCase();
      const arr = CITY_SUGGEST[countryCode]?.[state] || [];
      cityList.innerHTML = arr.map(c=>`<option value="${c}">`).join('');
      if(arr.length && !arr.includes(cityInput.value)) cityInput.value = arr[0];
    }

    // ======= Inicializar selects =======
    const oCountry = byId('oCountry'), dCountry = byId('dCountry');
    const oState = byId('oState'), dState = byId('dState');
    const oStateText = byId('oStateText'), dStateText = byId('dStateText');
    const oCity = byId('oCity'), dCity = byId('dCity');
    const oCityList = byId('oCityList'), dCityList = byId('dCityList');

    fillCountries(oCountry,'US'); fillCountries(dCountry,'US');
    populateStates(oCountry,oState,oStateText,oCity,oCityList);
    populateStates(dCountry,dState,dStateText,dCity,dCityList);

    oCountry.addEventListener('change',()=>populateStates(oCountry,oState,oStateText,oCity,oCityList));
    dCountry.addEventListener('change',()=>populateStates(dCountry,dState,dStateText,dCity,dCityList));
    oState.addEventListener('change',()=>updateCitySuggestions(oCountry.value,oState,oStateText,oCity,oCityList));
    dState.addEventListener('change',()=>updateCitySuggestions(dCountry.value,dState,dStateText,dCity,dCityList));

    // ======= Lógica de cotización / compra =======
    const btn = $('#btn'), results = $('#results'), msg = $('#msg');

    const carrierLogo = (c)=>
      c?.toLowerCase().startsWith('ups')   ? '<div class="logo ups">UPS</div>' :
      c?.toLowerCase().startsWith('fedex') ? '<div class="logo fedex">FX</div>' :
                                             '<div class="logo usps">US</div>';

    function niceDate(iso){
      if(!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    }

    function addr(prefix){
      const country = byId(prefix+'Country').value;
      const hasSelect = !byId(prefix+'State').classList.contains('hide');
      const stateVal = hasSelect ? byId(prefix+'State').value : byId(prefix+'StateText').value.trim();
      return {
        street1: byId(prefix+'Street').value.trim(),
        city:    byId(prefix+'City').value.trim(),
        state:   stateVal,
        zip:     byId(prefix+'Zip').value.trim(),
        country
      };
    }

    async function getRates(){
      msg.textContent=''; results.innerHTML=''; btn.disabled=true;
      try{
        const origin = addr('o'), destination = addr('d');
        const required = a=>a.street1 && a.city && a.zip && a.country && a.state;
        if(!required(origin) || !required(destination)){
          msg.textContent='Completa calle, ciudad, estado/provincia, ZIP y país en origen y destino.';
          btn.disabled=false; return;
        }
        const payload = {
          origin, destination,
          parcel:{
            weight_kg: Number(byId('w').value)||0.1,
            length_cm: Number(byId('l').value)||0,
            width_cm:  Number(byId('an').value)||0,
            height_cm: Number(byId('al').value)||0
          }
        };
        const r = await fetch('/api/rates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data = await r.json();
        if(!r.ok) throw new Error(JSON.stringify(data,null,2));

        const rows = (data.rates||[]).map(rate=>{
          const eta = rate.est_delivery_date ? `ETA ${niceDate(rate.est_delivery_date)}` : '—';
          return `
            <div class="card">
              ${carriersToLogo(rate.carrier)}
              <div>
                <div class="svc">${rate.carrier} · ${rate.service}</div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                  <span class="pill">${(rate.mode||'test').toUpperCase()}</span>
                  <span class="pill">${rate.delivery_days ?? '—'} días</span>
                  <span class="pill">${eta}</span>
                </div>
              </div>
              <div class="price">$${Number(rate.rate).toFixed(2)}</div>
              <button class="btn" onclick='buy("${rate.shipment_id}","${rate.rate_id}")'>Crear envío</button>
            </div>`;
        }).join('');
        results.innerHTML = rows || '<div class="err">Sin tarifas disponibles para esos datos.</div>';
      }catch(e){ msg.textContent = e.message || 'Error'; }
      finally{ btn.disabled=false; }
    }

    // alias para logo
    function carriersToLogo(c){ return carrierLogo(c); }

    async function buy(shipment_id, rate_id){
      try{
        const r = await fetch('/api/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({shipment_id, rate_id})});
        const data = await r.json();
        if(!r.ok) throw new Error(JSON.stringify(data,null,2));
        if(data.label_url){ window.open(data.label_url,'_blank'); }
        else { alert('Envío creado, pero no se devolvió label_url'); }
      }catch(e){ alert('Error al crear envío:\n'+(e.message||e)); }
    }

    byId('btn').addEventListener('click', getRates);
  </script>
</body>
</html>
