<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AhorraYa</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#161a22;--muted:#8a93a6;--text:#e6e9f2;--brand:#ff7a00;--pill:#22293a;--ok:#10b981;
      --field:#0f1320;--border:#1f2532;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1120px;margin:32px auto;padding:0 16px}
    h1{font-size:34px;margin:0 0 18px;font-weight:900}
    h2{font-size:14px;margin:0 0 8px;color:var(--muted);font-weight:600;letter-spacing:.02em}
    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    .four{grid-template-columns:repeat(4,1fr)}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    input,select{width:100%;background:var(--field);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
    input:focus,select:focus{border-color:#334155}
    .row{display:flex;gap:12px;align-items:end;flex-wrap:wrap}
    .btn{background:var(--brand);color:#101114;border:0;border-radius:10px;padding:12px 16px;font-weight:800;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .results{margin-top:16px}
    .card{display:flex;align-items:center;gap:16px;padding:14px 16px;border:1px solid var(--border);background:#121723;border-radius:12px}
    .card + .card{margin-top:10px}
    .logo{width:36px;height:36px;border-radius:999px;display:grid;place-items:center;font-weight:800}
    .usps{background:#224;color:#fff}.ups{background:#532;color:#fff}.fedex{background:#242;color:#fff}
    .svc{font-weight:700}
    .price{margin-left:auto;font-weight:900}
    .pill{font-size:12px;background:var(--pill);border:1px solid #2a3347;border-radius:999px;padding:4px 8px;color:var(--muted)}
    .err{color:#fda4af;white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace}
    @media (max-width:900px){
      .two{grid-template-columns:1fr}
      .four{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AhorraYa</h1>

    <!-- ORIGEN / DESTINO -->
    <div class="grid two">
      <div class="panel">
        <h2>Origen</h2>
        <div class="grid four">
          <div style="grid-column: span 2">
            <label>Calle</label>
            <input id="oStreet" placeholder="20102 NW 27th Cir" value="20102 NW 27th Cir">
          </div>
          <div>
            <label>Ciudad</label>
            <input id="oCity" placeholder="Miami Gardens" value="Miami Gardens">
          </div>
          <div>
            <label>Estado</label>
            <select id="oState">
              <option value="">—</option>
              <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option>
              <option value="AR">AR</option><option value="CA">CA</option><option value="CO">CO</option>
              <option value="CT">CT</option><option value="DC">DC</option><option value="DE">DE</option>
              <option value="FL" selected>FL</option><option value="GA">GA</option><option value="HI">HI</option>
              <option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option>
              <option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option>
              <option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
              <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option>
              <option value="MS">MS</option><option value="MO">MO</option><option value="MT">MT</option>
              <option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option>
              <option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
              <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option>
              <option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option>
              <option value="RI">RI</option><option value="SC">SC</option><option value="SD">SD</option>
              <option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
              <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option>
              <option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
            </select>
          </div>
          <div>
            <label>ZIP</label>
            <input id="oZip" placeholder="33056" value="33056">
          </div>
          <div>
            <label>País</label>
            <select id="oCountry"><option value="US" selected>US</option></select>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Destino</h2>
        <div class="grid four">
          <div style="grid-column: span 2">
            <label>Calle</label>
            <input id="dStreet" placeholder="1101 Brickell Ave" value="1101 Brickell Ave">
          </div>
          <div>
            <label>Ciudad</label>
            <input id="dCity" placeholder="Miami" value="Miami">
          </div>
          <div>
            <label>Estado</label>
            <select id="dState">
              <option value="">—</option>
              <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option>
              <option value="AR">AR</option><option value="CA">CA</option><option value="CO">CO</option>
              <option value="CT">CT</option><option value="DC">DC</option><option value="DE">DE</option>
              <option value="FL" selected>FL</option><option value="GA">GA</option><option value="HI">HI</option>
              <option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option>
              <option value="IA">IA</option><option value="KS">KS</option><option value="KY">KY</option>
              <option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
              <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option>
              <option value="MS">MS</option><option value="MO">MO</option><option value="MT">MT</option>
              <option value="NE">NE</option><option value="NV">NV</option><option value="NH">NH</option>
              <option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
              <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option>
              <option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option>
              <option value="RI">RI</option><option value="SC">SC</option><option value="SD">SD</option>
              <option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
              <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option>
              <option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
            </select>
          </div>
          <div>
            <label>ZIP</label>
            <input id="dZip" placeholder="33131" value="33131">
          </div>
          <div>
            <label>País</label>
            <select id="dCountry"><option value="US" selected>US</option></select>
          </div>
        </div>
      </div>
    </div>

    <!-- PAQUETE -->
    <div class="panel" style="margin-top:12px">
      <div class="row">
        <div style="min-width:140px;flex:1">
          <label>Peso (kg)</label><input id="w" type="number" step="0.01" value="2.5">
        </div>
        <div style="min-width:120px"><label>Largo (cm)</label><input id="l" type="number" step="1" value="30"></div>
        <div style="min-width:120px"><label>Ancho (cm)</label><input id="an" type="number" step="1" value="20"></div>
        <div style="min-width:120px"><label>Alto (cm)</label><input id="al" type="number" step="1" value="10"></div>
        <button id="btn" class="btn">Consultar tarifas reales</button>
      </div>
      <div id="msg" class="err" style="margin-top:10px"></div>
    </div>

    <!-- RESULTADOS -->
    <div id="results" class="results"></div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    const btn = $('#btn'), results = $('#results'), msg = $('#msg');

    function addr(prefix){
      return {
        street1: $(`#${prefix}Street`).value.trim(),
        city:    $(`#${prefix}City`).value.trim(),
        state:   $(`#${prefix}State`).value.trim(),
        zip:     $(`#${prefix}Zip`).value.trim(),
        country: $(`#${prefix}Country`).value
      };
    }

    const carrierLogo = (c)=>
      c?.toLowerCase().startsWith('ups')   ? '<div class="logo ups">UPS</div>' :
      c?.toLowerCase().startsWith('fedex') ? '<div class="logo fedex">FX</div>' :
                                             '<div class="logo usps">US</div>';

    function niceDate(iso){
      if(!iso) return '—';
      const d = new Date(iso);
      return d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    }

    async function getRates(){
      msg.textContent=''; results.innerHTML=''; btn.disabled=true;
      try{
        const origin = addr('o'), destination = addr('d');
        const required = (a)=>a.street1 && a.city && a.state && a.zip;
        if(!required(origin) || !required(destination)){
          msg.textContent='Completa calle, ciudad, estado y ZIP en origen y destino.';
          btn.disabled=false; return;
        }
        const payload = {
          origin, destination,
          parcel:{
            weight_kg: Number($('#w').value)||0.1,
            length_cm: Number($('#l').value)||0,
            width_cm:  Number($('#an').value)||0,
            height_cm: Number($('#al').value)||0
          }
        };
        const r = await fetch('/api/rates',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const data = await r.json();
        if(!r.ok) throw new Error(JSON.stringify(data,null,2));

        const rows = (data.rates||[]).map(rate=>{
          const eta = rate.est_delivery_date ? `ETA ${niceDate(rate.est_delivery_date)}` : '—';
          return `
            <div class="card">
              ${carrierLogo(rate.carrier)}
              <div>
                <div class="svc">${rate.carrier} · ${rate.service}</div>
                <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
                  <span class="pill">${(rate.mode||'test').toUpperCase()}</span>
                  <span class="pill">${rate.delivery_days ?? '—'} días</span>
                  <span class="pill">${eta}</span>
                </div>
              </div>
              <div class="price">$${Number(rate.rate).toFixed(2)}</div>
              <button class="btn" onclick='buy("${rate.shipment_id}","${rate.rate_id}")'>Crear envío</button>
            </div>`;
        }).join('');
        results.innerHTML = rows || '<div class="err">Sin tarifas disponibles para esos datos.</div>';
      }catch(e){ msg.textContent = e.message || 'Error'; }
      finally{ btn.disabled=false; }
    }

    async function buy(shipment_id, rate_id){
      try{
        const r = await fetch('/api/buy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({shipment_id, rate_id})});
        const data = await r.json();
        if(!r.ok) throw new Error(JSON.stringify(data,null,2));
        if(data.label_url){ window.open(data.label_url,'_blank'); }
        else { alert('Envío creado, pero no se devolvió label_url'); }
      }catch(e){ alert('Error al crear envío:\n'+(e.message||e)); }
    }

    btn.addEventListener('click', getRates);
  </script>
</body>
</html>
