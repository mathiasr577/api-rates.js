<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AhorraYa – Comparador</title>
  <style>
    :root { --bg:#0f1115; --card:#171923; --txt:#e6e8f0; --muted:#a0a3ad; --accent:#ff7a18; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    h1{margin:0 0 16px;font-weight:700}
    .card{background:var(--card);border:1px solid #232739;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .sec{padding:14px 16px;border-top:1px solid #232739}
    .sec:first-child{border-top:0;border-radius:14px 14px 0 0}
    .grid{display:grid;gap:10px}
    @media (min-width:720px){ .grid{grid-template-columns:1fr 1fr} .grid-4{grid-template-columns:repeat(4,1fr)} }
    label{font-size:12px;color:var(--muted);display:block;margin:2px 0 6px}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f42;background:#121525;color:var(--txt);outline:none}
    input:focus{border-color:#3d4370;box-shadow:0 0 0 3px rgba(61,67,112,.25)}
    .row{display:flex;gap:10px;align-items:center}
    .btn{appearance:none;border:0;border-radius:10px;background:var(--accent);color:#0b0d13;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:progress}
    .msg{white-space:pre-wrap;background:#0b0d13;color:#ffd9bf;border-radius:10px;padding:12px;border:1px dashed #3b2a1d}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #232739;text-align:left}
    th{color:var(--muted);font-weight:600}
    .pill{padding:2px 8px;border-radius:999px;background:#111523;color:#c9cbff;border:1px solid #2a2f42;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>AhorraYa</h1>
    <div class="card">
      <form id="form" class="sec">
        <div class="grid">
          <div>
            <label>Origen (calle / ciudad / estado / ZIP / país)</label>
            <input id="origin" placeholder="20102 NW 27th Cir, Miami Gardens, FL 33056, US"
                   value="20102 NW 27th Cir, Miami Gardens, FL 33056, US" />
          </div>
          <div>
            <label>Destino (calle / ciudad / estado / ZIP / país)</label>
            <input id="dest" placeholder="1101 Brickell Ave, Miami, FL 33131, US"
                   value="1101 Brickell Ave, Miami, FL 33131, US" />
          </div>
        </div>

        <div class="grid" style="margin-top:10px">
          <div>
            <label>Peso (kg)</label>
            <input id="w" type="number" step="0.01" min="0.01" value="2.5" />
          </div>
          <div class="grid-4">
            <div>
              <label>Largo (cm)</label>
              <input id="l" type="number" step="0.1" min="1" value="30" />
            </div>
            <div>
              <label>Ancho (cm)</label>
              <input id="b" type="number" step="0.1" min="1" value="20" />
            </div>
            <div>
              <label>Alto (cm)</label>
              <input id="h" type="number" step="0.1" min="1" value="10" />
            </div>
            <div class="row" style="align-self:end;justify-content:flex-end">
              <button id="go" class="btn" type="submit">Consultar tarifas reales</button>
            </div>
          </div>
        </div>
      </form>

      <div id="panel" class="sec">
        <div id="status" class="msg" style="display:none"></div>
        <div style="overflow:auto">
          <table id="tbl" style="display:none">
            <thead>
              <tr>
                <th>Carrier</th>
                <th>Servicio</th>
                <th>Precio</th>
                <th>Días</th>
                <th>Entrega</th>
                <th class="pill">modo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

const fmtCurrency = (n, c = "USD") =>
  new Intl.NumberFormat("en-US", { style: "currency", currency: c }).format(Number(n || 0));

const showMsg = (text) => {
  const box = $("status");
  box.textContent = text;
  box.style.display = "block";
  $("tbl").style.display = "none";
};

const showRates = (rates) => {
  const tbl = $("tbl");
  const tbody = tbl.querySelector("tbody");
  tbody.innerHTML = "";

  if (!rates?.length) {
    showMsg("No se recibieron tarifas. Prueba con otras dimensiones/direcciones.");
    return;
  }
  $("status").style.display = "none";
  tbl.style.display = "table";

  // ordenar por precio
  rates.sort((a, b) => Number(a.rate) - Number(b.rate));

  for (const r of rates) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.carrier || "-"}</td>
      <td>${r.service || "-"}</td>
      <td><strong>${fmtCurrency(r.rate, r.currency || "USD")}</strong></td>
      <td>${r.delivery_days ?? "—"}</td>
      <td>${r.delivery_date ? new Date(r.delivery_date).toLocaleDateString() : "—"}</td>
      <td><span class="pill">${(r.mode || "test").toUpperCase()}</span></td>
    `;
    tbody.appendChild(tr);
  }
};

$("form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const btn = $("go");
  btn.disabled = true;

  try {
    const origin = $("origin").value.trim();
    const destination = $("dest").value.trim();
    const parcel = {
      weight_kg: Number($("w").value),
      length_cm: Number($("l").value),
      width_cm: Number($("b").value),
      height_cm: Number($("h").value),
    };

    const resp = await fetch("/api/rates", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ origin, destination, parcel }),
    });

    const data = await resp.json();

    if (!resp.ok) {
      showMsg(JSON.stringify(data, null, 2));
    } else {
      showRates(data);
    }
  } catch (err) {
    showMsg(String(err));
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>

